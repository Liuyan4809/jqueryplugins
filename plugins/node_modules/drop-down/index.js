(function($) {

  /**
   * 
   */
  function Bob(origin, module, options) {
    // 默认配置
    let g_default_options = {
      title: '', // 下拉按钮标题
      icon: '', // 下拉按钮图标
      data: [], // 渲染数据
      unique: 'value', // 数据的唯一标识
      display: 'display' ,// 数据的展示内容
      theme: 'default' ,// [default,simple][默认主题,简单主题]
    };
    // 下拉模块
    let g_module = null;
    // 原始元素
    let g_$origin = null;
    // 渲染元素DOM
    let g_$target = null;
    // 下拉容器
    let g_$selectAnim = null;
    // 选择主题事件
    let g_onChange = null;
    // 注册模块
    let g_register = {
      chartTheme: function() { // 主题模块
        // 默认主题
        // let url = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAANCAYAAABy6+R8AAABRUlEQVQoU51SLUhDYRQ95/uGGAYTm4hGg8FiMFjWBPfz3sba9lY0aXIgiEUsIggzadKynyb7Z2BbMSxYDAajQ2ziYEFk33dlg2fS8tKFc7jncO49BIDthHdAjQKBBRE+am0KrVr1IZnObhqji6SsC/AuBsVuu3zJyYLSyGmx3nD49hKeX3bF4poiO0LeUmFv9PHaiEQWVwxV2RpUGHO9QUjsVrNZfZ64Tp2T+ROlcGwtzrqt0qmPO052dUx1z7jrjUefg9lerzf2ybiTT4GoQZDuNEt1H49Go6Hw3NIXY06+T42LTq1055MJN+cKVJ2wqXaj0vgVS+czYnDIaVir62JxpYgn0ooRbijyyIqca0pfRNEK1qiwr5VJcaISd7wEyInTjK/6x/yGSKbTLLeDOQXKFOx6Qf70XyNguQslN382Ikj3fgATee9mafrWAQAAAABJRU5ErkJggg==';
        // 小清新主题
        let url = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAANCAYAAABy6+R8AAAA5ElEQVQoU53SoUpEYRAF4O+AiK/gCxgMFoPBBzAJrmzUpEmTgiAWsSyCoEmTJo2igskHMBgsBoPV4CuICFdG7sKGTTfNMP+cc2bmP4GmaXawi2m8Vp7kuWmaRZxiHl+VJzlLC1jDOj6wggts4ApbeMAMrnFToE8sJXkv1Vb5EAcYJDkaqc/iqUC/mEpScQjq4Q6rSe5H6hP4LtALTpLcjjzWiNXcS1KjDcn62CtQLVsN53iru2AB+zhGkQZz2P4nandYRilNDlnHxB/0kzx2U+q6U6frdfqnstA4R2zicqwjunjvD/KilphxHKowAAAAAElFTkSuQmCC';
        // 模块标题(显示再下拉按钮的内容)
        g_default_options.title = '图表主题';
        // 图表地址
        g_default_options.icon = url;
        // 下拉模块
        g_default_options.module = 'chart-theme';
      },
      chartType: function() { // 图表类型模块
        // 默认主题
        // let url = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAANCAYAAABy6+R8AAABDUlEQVQoU52QIU/DUBSFz3mlCgQGxPBIBG4/AJKlo31zCNqAQJCAIARBwj9BUZYgSkLXtSFYDMncpnBg4B8gILx3yUhGBispcO093z3nHuIfQy+IchB1QgZVvIBLENxyKPSC8KronDWqoJHuV5DWm7MvNMvK4nB4vBJabYXzrsWF46gjY+xxKeStRXsO2c+y0xvfX68ZugnJ/TyNe6XxPD88gMIihHNC3CugDtqd/LLdH//9M55V0lZGrRRZvAVAGq2NaOrN9Lrd87tRQRNOlq+7M659SJLE/NTin9qbcGrq6FqAGgTP4w4kFkTw+MWVmCbw9PFT2Xg6Sos01mW7UqgZRCcgNARp3om3v4PvVtiGbSJwu0UAAAAASUVORK5CYII=';
        // 小清新主题
        let url = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAANCAYAAABy6+R8AAAAyUlEQVQoU52QL8/BcRTFPycrCoEuCpoXIGhegU0QbAQz4dmed6JqBMFmqmLTSBqFdyDasa897NnP1/y58d77ueeeI74o2Z4CZWDzBl8ElgqLtmeSqq+g295bkO00UAL64fhLyHYWGAM/wG8Ust0B1pIWtnPACOhKWkXfs90DCkAG2P0F1JK0/u/9/h4wBCpAQwqhug6sJG1vAT0oAW1gL+n8LMWP0ntQsj0HguFTQiEPHBK9FHC8eoqV7YmkWmwWhWwPgAAEsJkEL70Tb3UVcwrlAAAAAElFTkSuQmCC';
        // 模块标题(显示再下拉按钮的内容)
        g_default_options.title = '图表类型';
        // 图表地址
        g_default_options.icon = url;
        // 下拉模块
        g_default_options.module = 'chart-type';
      },
      customList: function() { // 自定义列表模块
        // 默认主题
        // let url = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAABTklEQVQ4T52SzUrDQBSF782QQlNB30DEnYo/3fgAQqBt2kS602aWPoF7BUFxpYIv0ETcSHHSpi6KuNWl+ALixgcQGsQ4uZKWYAplFp3tme9c7j0HYcaHlsMfAWgNCGnkgVAgoJO+8C9VnmjZ/CMMvMXsU6XJt7SETvv3fsWy+TMALkwYIH2FwtvGmsPf+8JbysSqs7eJyM5S0DTdkmEwPQ9GkYwHA3+oBBtNvh6TNPKgjizqdry3FPzUQVvJRCllmRgehsKrWrZ7AwilyV0xCoW3j5btXgNoO5lIkCSM4Ljb9e+Ux5kxDUgnXgFo5r8BSUQ86ol2Rzkx3RHi31VdL4xylCjLROMd6w73CWhuwoBgGAZ+S3lVa7e1IZGKeRAT+n4Qt69KsF4/MBj7KUzNUdWcmu2+IGjz05tj8ycEWCaEZFxVLCLBeS9oX6iO8weGG6YPk5yo0wAAAABJRU5ErkJggg==';
        // 小清新主题
        let url = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAAA8UlEQVQ4T52SzSpFYRSGn2dA+RlwBciQ/E1cgFK4BO5C5keKjFDugJncAVPG3AAGXIA6R/lpadU+9bXr7F1nTdf3vGt9631lyDIi7oBFICqNUeBIPW/STPBNnek/iohV4FjdiogHYLom8KmuJ/iizhXgCnBSgRPASA38Ubtt4BIwXgN76nOC78BC0cxVD9TtiLgGcmpZCe4meAlsFJ0/4FC9aTzOkG6QEy+AzULgF+iot212fFR/7Pu4BuyrOxFxBUzWBLrqXttVl4GxGvilPrWBaUUmqaxvtZfgqzo7IDmPwNSg5NwD80VWc7VT9azpOP9CfXsPRObKrgAAAABJRU5ErkJggg==';
        // 模块标题(显示再下拉按钮的内容)
        g_default_options.title = '自定义列表';
        // 图表地址
        g_default_options.icon = url;
        // 下拉模块
        g_default_options.module = 'custom-list';
      },
      customGroupByList: function() { // 自定义列表模块
        // 默认主题
        // let url = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAABTklEQVQ4T52SzUrDQBSF782QQlNB30DEnYo/3fgAQqBt2kS602aWPoF7BUFxpYIv0ETcSHHSpi6KuNWl+ALixgcQGsQ4uZKWYAplFp3tme9c7j0HYcaHlsMfAWgNCGnkgVAgoJO+8C9VnmjZ/CMMvMXsU6XJt7SETvv3fsWy+TMALkwYIH2FwtvGmsPf+8JbysSqs7eJyM5S0DTdkmEwPQ9GkYwHA3+oBBtNvh6TNPKgjizqdry3FPzUQVvJRCllmRgehsKrWrZ7AwilyV0xCoW3j5btXgNoO5lIkCSM4Ljb9e+Ux5kxDUgnXgFo5r8BSUQ86ol2Rzkx3RHi31VdL4xylCjLROMd6w73CWhuwoBgGAZ+S3lVa7e1IZGKeRAT+n4Qt69KsF4/MBj7KUzNUdWcmu2+IGjz05tj8ycEWCaEZFxVLCLBeS9oX6iO8weGG6YPk5yo0wAAAABJRU5ErkJggg==';
        // 小清新主题
        let url = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAAA8UlEQVQ4T52SzSpFYRSGn2dA+RlwBciQ/E1cgFK4BO5C5keKjFDugJncAVPG3AAGXIA6R/lpadU+9bXr7F1nTdf3vGt9631lyDIi7oBFICqNUeBIPW/STPBNnek/iohV4FjdiogHYLom8KmuJ/iizhXgCnBSgRPASA38Ubtt4BIwXgN76nOC78BC0cxVD9TtiLgGcmpZCe4meAlsFJ0/4FC9aTzOkG6QEy+AzULgF+iot212fFR/7Pu4BuyrOxFxBUzWBLrqXttVl4GxGvilPrWBaUUmqaxvtZfgqzo7IDmPwNSg5NwD80VWc7VT9azpOP9CfXsPRObKrgAAAABJRU5ErkJggg==';
        // 模块标题(显示再下拉按钮的内容)
        g_default_options.title = '自定义维度';
        // 图表地址
        g_default_options.icon = url;
        // 下拉模块
        g_default_options.module = 'custom-group-list';
      }
    }
    // 设置
    g_$origin = origin;
    // 初始化插件
    init(module, options);
    
    
    /**
     * 初始化方法
     */
    function init(module, options) {
      // 注册组件默认属性
      g_register[module]();
      // 动态加载下拉模块
      loadModule().then(function(m) {
        // 下拉模块实例
        g_module = m.default;
        // 融合配置项(用户配置优先)
        g_default_options = deepCopy(Object.assign(g_default_options, options));
        // 渲染主体内容
        render();
        // 绑定事件
        bindDocument();
        g_$origin.trigger('done');
      });
    }

    /**
     * 渲染
     */
    function render() {
      // 去掉之前添加的内容
      g_$origin.next('.drop-down').remove();
      let html =
        `<div class="drop-down ${g_default_options.module} ${'theme-'+g_default_options.theme}">
        <div class="drop-down__title">
          <button lay-ignore type="button" class="drop-down__button">
            <i class="icon icon-sign" style="background-image:url('${g_default_options.icon}')"></i>
            ${g_default_options.title}
            <i class="icon icon-edag"></i>
          </button>
        </div>
        <div class="drop-down__anim"></div>
      </div>`;
      // 渲染主体
      g_$target = g_$origin.after(html).next('.drop-down');
      // 渲染下拉模块内容
      g_module.render(g_$target, g_default_options, g_$origin);
    }
    
    let setVal = function(){
      // 重新渲染自定义列表内容
      Array.prototype.shift.apply(arguments);
      g_default_options.checked = Array.prototype.slice.apply(arguments);
      // 渲染主体内容
      render();
      // 绑定事件
      bindDocument();
      // g_$origin.trigger('change',{list:g_default_options.checked});
    };
    
    let fn = function(dropDown) {
      return function(e){
        let $t = $(e.target);
        // 设计下拉 - 主题
        if (!$t.closest('.'+g_default_options.module).length) {
          dropDown.removeClass('drop-down__selected');
          dropDown.trigger( 'close' );
        }
      }
    }

    /**
     * 点击非组件位置,关闭组件
     */
    function bindDocument() {
      // 解绑事件
      $(document).off('click', fn(g_$target));
      // 重新绑定
      $(document).on('click', fn(g_$target));
      g_$origin.off('setVal',setVal);
      g_$origin.on('setVal',setVal);
    }



    /**
     * 动态加载模块
     */
    function loadModule() {
      return import('./modules/' + g_default_options.module + '/index.js');
    }
    
  }
  
  /**
   * 深拷贝
   * @param {Object} obj 被拷贝对象
   */
  function deepCopy(obj) {
    return (function fn(obj) {
      let clonedObj;
      // 判断直接数据类型
      if (['number', 'string', 'boolean', 'undefined', 'symbol', ].includes(typeof obj) || obj === null) {
        clonedObj = obj;
        return clonedObj;
      }
      const constructor = obj.constructor || Object;
      // 判断改对象是否为日期格式
      if (obj.getTime) {
        clonedObj = new constructor(obj);
      } else {
        clonedObj = new constructor();
      }
      Object.entries(obj).forEach(([key, value]) => {
        clonedObj[key] = fn(value);
      })
      return clonedObj;
    })(obj);
  }

  $.fn.extend({
    "dropDown": function(module, options) {
      Bob(this, module, options);
      return this;
    }
  });

})(jQuery);
